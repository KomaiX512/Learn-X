#!/bin/bash

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ฌ COMPLETE PRODUCTION TEST WITH FRESH START"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Kill any existing processes
echo "๐งน Cleaning up old processes..."
pkill -9 -f "ts-node-dev.*backend" 2>/dev/null
pkill -9 -f "vite.*5174" 2>/dev/null
sleep 2

# Start backend
echo "๐ Starting backend..."
cd /home/komail/LeaF/app
npm run dev > /tmp/backend_test.log 2>&1 &
BACKEND_PID=$!
echo "   Backend PID: $BACKEND_PID"

# Wait for backend to start
echo "โณ Waiting for backend to start (15 seconds)..."
sleep 15

# Check if backend is running
if ! curl -s http://localhost:3001/ > /dev/null 2>&1; then
    echo "โ Backend failed to start!"
    tail -20 /tmp/backend_test.log
    exit 1
fi

echo "โ Backend is running!"
echo ""

# Run the comprehensive test
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งช RUNNING COMPREHENSIVE TEST"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

cd /home/komail/LeaF
timeout 75 node COMPLETE_SYSTEM_TEST.js 2>&1 | tee /tmp/test_output.txt

# Show backend logs
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ BACKEND LOGS (Last 50 lines)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
tail -50 /tmp/backend_test.log

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ TEST COMPLETE - Check complete_system_analysis.json for details"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
